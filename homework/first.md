##  概述

DSR协议意为动态源路由协议，是在移动节点组成的多条无线自组网络中应用的路由协议。该协议主要由“路由发现”和“路由维护”两个机制组成。二者协同工作允许节点发现并维护到自组网中任一目的点的路由。协议的所有方面都是按需操作的，允许DSR路由数据包的开销自动适配到应对当前路由变化所需的大小。该协议允许到任一目的地的多条路由，并且允许每个发送方选择控制发送数据包时使用的路由。这种机制可用于实现负载平衡和增强数据传送的稳定性。

# 详细处理

## 1.常规包处理

### 1.1初始化一个包

包结构的定义如下(dsr-pkt.h)：

![avatar](E:\network\homework\包结构定义.png)

dsr_pkt_alloc(dsr-pkt.h)用于初始化一个包：

![avatar](E:\network\homework\初始化包.png)

​	首先，在该节点的路由缓存中搜索数据包首部目标IP地址字段对应地址的路由。

​	如果在路由缓存中没有找到这样的路由，则对目标地址执行路由发现操作。对目标地址执行路由发现操作会在这个现有的包添加一个路由请求选项（RREQ_OPT）,或者将现有的数据包保存到缓冲区并通过发送一个包含以上路由请求的选项的数据包来启动路由发现。如果选择前者，数据包首部的目的IP地址将被替换为广播地址（255.255.255.255），原始的目的IP地址被复制到新的路由请求的目的地址字段选项添加到数据包中。

​	如果数据包现在不包含路由请求选项，则该节点必须具有到数据包的目的地址的路由；如果节点有不止一条到该目的地址的路由，则由节点选择一条路由进行数据包的转发。如果选择的路径的长度大于一跳，或者当前节点决定在这条路由的第一条请求一个DSR层级的ACK，将在当前数据包中插入一个DSR选项头和DSR源路由选项。

​	然后将数据包发送到选定路由中给定的第一跳节点地址，同时利用路由维护机制来确保下一跳的可达性。

### 1.2将DSR选项头添加进数据包中

![avatar](E:\network\homework\添加选项头.png)

​	发送包的节点在必要时向包添加DSR选项头，以携带路由协议所需的信息。一个包不能包含多于一个DSR选项头。DSR选项头通过执行以下步骤添加到包中：

​		1.在IP首部后面插入DSR选项头，但要在可能出现的任何其他首部之前插入。

​		2.将DSR选项头的下一个首部字段设置为数据包的IP首部的协议号字段。

​		3.将数据包IP首部的协议字段设置为分配给DSR的协议号。

### 1.3将DSR源路由选项添加进包中

​	DSR源路由选项结构体：

![avatar](E:\network\homework\DSR源路由选项.png)

添加源路由选项：

![avatar](E:\network\homework\添加源路由选项.png)

​	如果需要，发送数据包的节点向数据包中添加DSR源路由选项，以确保将源路由信息从该节点传送到数据包的最终目的地址。具体来说，添加DSR源路由选项的节点构造DSR源路由选项，并按照一下步骤修改IP数据包：

​		1.节点创建DSR源路由选项，并将其追加到包中的DSR选项头。