# 概述

DSR协议意为动态源路由协议，是在移动节点组成的多条无线自组网络中应用的路由协议。该协议主要由“路由发现”和“路由维护”两个机制组成。二者协同工作允许节点发现并维护到自组网中任一目的点的路由。协议的所有方面都是按需操作的，允许DSR路由数据包的开销自动适配到应对当前路由变化所需的大小。该协议允许到任一目的地的多条路由，并且允许每个发送方选择控制发送数据包时使用的路由。这种机制可用于实现负载平衡和增强数据传送的稳定性。

# 详细处理

## 1.常规包处理

### 1.1初始化一个包

包结构的定义如下(dsr-pkt.h)：

![avatar](E:\network\homework\包结构定义.png)

dsr_pkt_alloc(dsr-pkt.h)用于初始化一个包：

![avatar](E:\network\homework\初始化包.png)

​	首先，在该节点的路由缓存中搜索数据包首部目标IP地址字段对应地址的路由。

​	如果在路由缓存中没有找到这样的路由，则对目标地址执行路由发现操作。对目标地址执行路由发现操作会在这个现有的包添加一个路由请求选项（RREQ_OPT）,或者将现有的数据包保存到缓冲区并通过发送一个包含以上路由请求的选项的数据包来启动路由发现。如果选择前者，数据包首部的目的IP地址将被替换为广播地址（255.255.255.255），原始的目的IP地址被复制到新的路由请求的目的地址字段选项添加到数据包中。

​	如果数据包现在不包含路由请求选项，则该节点必须具有到数据包的目的地址的路由；如果节点有不止一条到该目的地址的路由，则由节点选择一条路由进行数据包的转发。如果选择的路径的长度大于一跳，或者当前节点决定在这条路由的第一条请求一个DSR层级的ACK，将在当前数据包中插入一个DSR选项头和DSR源路由选项。

​	然后将数据包发送到选定路由中给定的第一跳节点地址，同时利用路由维护机制来确保下一跳的可达性。

### 1.2将DSR选项头添加进数据包中

![avatar](E:\network\homework\添加选项头.png)

​	28-40: 首先定义每个选项头的固定部分，之后判断如果长度足够，则开始装载相关设置，将参数中缓冲区指针强制类型转换为一个指向DSR选项头的指针。Next header字段设置为数据分组的IP头的协议号，最后返回该指针。

​	发送包的节点在必要时向包添加DSR选项头，以携带路由协议所需的信息。一个包不能包含多于一个DSR选项头。DSR选项头通过执行以下步骤添加到包中：

​		1.在IP首部后面插入DSR选项头，但要在可能出现的任何其他首部之前插入。

​		2.将DSR选项头的下一个首部字段设置为数据包的IP首部的协议号字段。

​		3.将数据包IP首部的协议字段设置为分配给DSR的协议号。

### 1.3将DSR源路由选项添加进包中

RFC文档给出DSR源路由选项的定义:

​	![avatar](E:\network\homework\RFC源路由选项.png)

DSR源路由选项结构体：

![avatar](E:\network\homework\DSR源路由选项.png)

​	23-42：sleft记录剩余路段的数量，即在到达最终目的地之前仍需要访问的中间节点的数量。变长数组addrs记录源路由的路径信息。其他字段同上。

​	发起分组的节点在需要时向分组添加DSR源路由选项，以便将来自该始发节点的源路由携带到分组的最终目的地址。

添加源路由选项：

![avatar](E:\network\homework\添加源路由选项.png)

​	297-312：选项头固定部分定义，缓冲区长度判断及指针转换同上，然后开始装载选项字段，将类型设置为源路由选项，初始化长度，标志位，抢救次数等，随后数据分组中的地址被复制到DSR源路由选项中的addrs数组字段。

​	如果需要，发送数据包的节点向数据包中添加DSR源路由选项，以确保将源路由信息从该节点传送到数据包的最终目的地址。具体来说，添加DSR源路由选项的节点构造DSR源路由选项，并按照以下步骤修改IP数据包：

​		1.节点创建DSR源路由选项，并将其追加到包中的DSR选项头。

​		2.DSR源路由选项（n）中包含的Address[i]字段的数量是源路由中的中间节点数量。DSR源路由选项中的segment left字段初始化为n。

​		3.数据包源路由中的地址被复制到DSR源路由选项中的顺序地址[i]字段中，其中 i= 1,2,…,n。

​		4.DSR源路由选项中的(F)位(First Hop External)是从标记包源路由中第一跳的外部位复制的，如路由缓存中所示。

​		5.DSR源路由选项中的(L)位(Last Hop External)是从标记包源路由中最后一跳的外部位复制的，如路由缓存中所示。

​		6.DSR源路由选项中的打捞字段(补救字段)初始化为 0。

### 1.4 处理一个接收到的包

​	当一个节点收到任何数据分组时，如果该数据分组包含一个DSR选项头，那么该节点必须处理该DSR选项头中包含的所有选项。处理路由请求的代码实现如下：

![avatar](E:\network\homework\dsr_recv1.png)

​	31-43:节点会跟据数据包携带的选项来进行不同的处理操作，调用的dsr_opt_recv函数通过对数据包中选项的类型进行识别然后返回对应的操作类型，随后使用switch语句根据返回的操作类型进行不同的操作，在这些分支中这里着重分析较为复杂的转发请求（DSR_PKT_FORWARD），代码如下：

![avatar](E:\network\homework\dsr_recv_case_forward.png)

​	首先进行生存期ttl的判断，如果ttl小于一（即为0）则丢弃数据包，否则调用XMIT函数转发数据包，XMIT说如下函数dsr_dev_xmit的宏定义，函数代码如下：

![avatar](E:\network\homework\dsr_xmit1.png)

​	其中，结构体sk_buff与m_buf类似，是linux系统中各层协议之间传递数据的重要载体，net_device结构体用来描述一个网络设备，dst字段标记目标地址：

![avatat](E:\network\homework\dsr_xmit_p2.png)

​	

497-507: 通过锁来实现dsr_node(描述当前节点信息)的并发安全性，将抢救网卡设备指定为当前节点的相应设备字段，随后调用dsr_skb_create函数（装填相关字段信息并返回一个sk_buff的指针）创建数据分组。

515-538：随后开始向创建后的数据分组中装填mac地址相关字段，并调用dev_queue_xmit函数进行发送。

​	当某个节点接收到一个数据包时，如果这个数据包包含DSR选项头，该节点必须处理所有包含在该DSR选项头中的选项，步骤如下：

​	如果选项头中包含一个路由请求选项（路由发现），节点应该从路由请求中提取源路由，并将该路由信息添加到自己的路由缓存中。路由请求中的路由信息序列是地址发起者，地址[1]，地址[2]，...，地址[n]。每个地址是通过这条路由请求已经经过的节点。这里n是路由请求选项中记录的地址数。

​	在可能更新节点的路由缓存已响应路由请求选项中的路由信息之后，节点必须按照2.2节所述方式处理路由请求选项。

​	如果DSR选项头包含路由应答选项，节点应该从路由应答中提取源路由，并将该路由信息添加到其路由缓存中。

​	在可能更新节点的路由缓存已响应路由应答选项中的路由信息之后，如果数据包的IP目的地址与该节点的某个IP地址匹配，则节点必须按照2.6节所述方式处理路由应答选项。

​	如果DSR选项头包含ACK选项，节点应将从ACK源地址字段标识的节点到ACK目的地址字段表示的节点的单个链路添加到路由缓存。

​	在可能响应已确认选项中的路由信息更新节点的路由缓存之后，节点必须继续处理3.3节中描述的确认选项。

​	如果DSR选项头包含DSR源路由选项，节点应该从DSR源路由中提取源路由，并将该路由信息添加到其路由缓存中。如果打捞字段的值在DSR源路由选项是零，然后从DSR路由信息的源路由的顺序跳地址，如果打捞非零，从DSR路由信息来源途径是跳地址的顺序的值是在源中的源地址字段IP首部的数据包携带DSR源路由选项（原始数据报的发送者），每个地址[i]是DSR源路由中的地址[i]字段的值，目的地址是数据包的IP首部中目标地址字段的值（源路由的最后一跳地址）。

​	最后，如果数据包IP首部中的目标地址与该接收节点的IP地址（es）匹配，则删除DSR选项头和头部中包含的所有DSR选项，并将剩余的数据包向上传递到网络层。

### 1.5处理收到的DSR源路由选项

